(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     13470,        318]
NotebookOptionsPosition[     13104,        303]
NotebookOutlinePosition[     13514,        320]
CellTagsIndexPosition[     13471,        317]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Clear", "[", "invariantGenerate", "]"}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "Function", " ", "for", " ", "time", " ", "invariant", " ", "generation"}],
    " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"invariantGenerate", "[", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "equalityAdjust", ",", "inequalityAdjust", ",", "  ", 
      "myProbAdjustEquals", ",", "myProbAdjustUnequals", ",", " ", "oParams", 
      ",", " ", "oOutput", ",", " ", "oEquations", ",", " ", "oConstraints", 
      ",", " ", "oSolve", ",", " ", "oRules", ",", " ", "oFinalRules", ",", 
      " ", "oD", ",", " ", "underCheck"}], "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Print", "[", "\"\<Before\>\"", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"variables", ",", " ", "values"}], "}"}], " ", "=", " ", 
      RowBox[{"timeVarVals", "[", 
       RowBox[{"timesteps", ",", " ", "variables", ",", " ", "values"}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "\"\<Adjust Lists\>\"", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "variables", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "values", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"equalityAdjust", " ", "=", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Equal", "[", 
         RowBox[{"test1_", ",", " ", "test2_"}], "]"}], ")"}], " ", 
       "\[RuleDelayed]", " ", 
       RowBox[{"switchEquals", "[", 
        RowBox[{
         RowBox[{"Equal", "[", 
          RowBox[{"test1", ",", " ", "test2"}], "]"}], ",", "variables", ",", 
         " ", "values"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"inequalityAdjust", " ", "=", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Unequal", "[", 
         RowBox[{"test1_", ",", " ", "test2_"}], "]"}], ")"}], " ", 
       "\[RuleDelayed]", " ", 
       RowBox[{"switchUnequals", "[", 
        RowBox[{
         RowBox[{"Unequal", "[", 
          RowBox[{"test1", ",", " ", "test2"}], "]"}], ",", "variables", ",", 
         " ", "values"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"myProbAdjustEquals", "=", " ", 
      RowBox[{
       RowBox[{"myProb", "[", "test3_", "]"}], " ", "\[RuleDelayed]", " ", 
       RowBox[{"myProb", "[", " ", 
        RowBox[{"test3", " ", "/.", " ", "equalityAdjust"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"myProbAdjustUnequals", "=", " ", 
      RowBox[{
       RowBox[{"myProb", "[", "test3_", "]"}], " ", "\[RuleDelayed]", " ", 
       RowBox[{"myProb", "[", " ", 
        RowBox[{"test3", " ", "/.", " ", "inequalityAdjust"}], "]"}]}]}], ";",
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"NOTE", ":", " ", 
       RowBox[{
       "specs", " ", "works", " ", "until", " ", "the", " ", "second", " ", 
        "myProbAdjustEquals", " ", "call", "\[IndentingNewLine]", "Something",
         " ", "wrong", " ", "with", " ", "using", " ", "the", " ", 
        "variables", " ", "as", " ", "lists", " ", "here"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"specs", " ", "=", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"specs", " ", "//.", " ", "myProbAdjustEquals"}], " ", "//.",
          " ", "myProbAdjustUnequals"}], " ", "//.", "definizeRule"}], " ", "//.",
        " ", "eventsToDNFExtRule"}]}], "  ", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"//.", " ", "myProbAdjustEquals"}], " ", "//.", " ", 
       "myProbAdjustUnequals"}], " ", "*)"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "\"\<After\>\"", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "specs", "]"}], ";"}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{
     "Removing", " ", "all", " ", "the", " ", "OR", " ", "operations", " ", 
      "in", " ", "the", " ", "myProb", " ", "and", " ", "myCondProb", " ", 
      "statements"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"equalityAdjust", " ", "=", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Equal", "[", 
         RowBox[{"test1_", ",", " ", "test2_"}], "]"}], ")"}], " ", 
       "\[RuleDelayed]", " ", 
       RowBox[{"switchEquals", "[", 
        RowBox[{
         RowBox[{"Equal", "[", 
          RowBox[{"test1", ",", " ", "test2"}], "]"}], ",", "variables", ",", 
         " ", "values"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"inequalityAdjust", " ", "=", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Unequal", "[", 
         RowBox[{"test1_", ",", " ", "test2_"}], "]"}], ")"}], " ", 
       "\[RuleDelayed]", " ", 
       RowBox[{"switchUnequals", "[", 
        RowBox[{
         RowBox[{"Unequal", "[", 
          RowBox[{"test1", ",", " ", "test2"}], "]"}], ",", "variables", ",", 
         " ", "values"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"myProbAdjustEquals", "=", " ", 
      RowBox[{
       RowBox[{"myProb", "[", "test3_", "]"}], " ", "\[RuleDelayed]", " ", 
       RowBox[{"myProb", "[", " ", 
        RowBox[{"test3", " ", "/.", " ", "equalityAdjust"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"myProbAdjustUnequals", "=", " ", 
      RowBox[{
       RowBox[{"myProb", "[", "test3_", "]"}], " ", "\[RuleDelayed]", " ", 
       RowBox[{"myProb", "[", " ", 
        RowBox[{"test3", " ", "/.", " ", "inequalityAdjust"}], "]"}]}]}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"specs", " ", "=", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"specs", " ", "//.", " ", "myProbAdjustEquals"}], " ", "//.",
            " ", "myProbAdjustUnequals"}], " ", "//.", "definizeRule"}], " ", 
         "//.", "eventsToDNFExtRule"}], " ", "//.", " ", 
        "myProbAdjustEquals"}], " ", "//.", " ", "myProbAdjustUnequals"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "\"\<After\>\"", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "specs", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Parameterizing", " ", "the", " ", "specifications", " ", "with", " ", 
       "generated", " ", "o", " ", "parameters"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"oParams", " ", "=", " ", 
      RowBox[{"oGen", "[", " ", 
       RowBox[{"variables", ",", " ", "values"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"oOutput", " ", "=", " ", 
      RowBox[{"oOutcomes", "[", "oParams", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"oEquations", "=", " ", 
      RowBox[{
       RowBox[{"specs", " ", "/.", " ", "unconditionedProbability"}], " ", "/.",
        " ", "conditionedProbability"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", "oEquations", "]"}], ";"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"AppendTo", "[", 
      RowBox[{"oEquations", ",", " ", 
       RowBox[{"givenEquation", "[", "oParams", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Solving", " ", "the", " ", "probability", " ", "system", " ", "based", 
       " ", "on", " ", "the", " ", "specifications", " ", "and", " ", 
       "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"oConstraints", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "\[Element]", 
         RowBox[{"Interval", "[", 
          RowBox[{"{", 
           RowBox[{"0", ",", "1"}], "}"}], "]"}]}], "&"}], "/@", 
       "oOutput"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"oSolve", " ", "=", " ", 
      RowBox[{"TimeConstrained", "[", 
       RowBox[{
        RowBox[{"Solve", "[", 
         RowBox[{
          RowBox[{"Join", "[", 
           RowBox[{"oEquations", ",", "oConstraints"}], "]"}], ",", "oOutput",
           ",", "Reals"}], "]"}], ",", "60", ",", "$Failed"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"FailureQ", "[", "oSolve", "]"}], ",", 
       RowBox[{
       "Print", "[", "\"\<Invalid system: solver timed out\>\"", "]"}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Generating", " ", "data", " ", "by", " ", "placing", " ", "the", " ", 
       "solution", " ", "into", " ", "a", " ", "categorical", " ", 
       "distribution"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"FailureQ", "[", "oSolve", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "oSolve", "]"}], " ", "\[NotEqual]", " ", 
           "1"}], " ", "||", " ", 
          RowBox[{
           RowBox[{"Length", "[", 
            RowBox[{"oSolve", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}], " ", "\[NotEqual]", " ", 
           RowBox[{"Length", "[", "oOutput", "]"}]}]}], ",", " ", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"underCheck", " ", "=", " ", 
           RowBox[{"TimeConstrained", "[", 
            RowBox[{
             RowBox[{"FindInstance", "[", 
              RowBox[{
               RowBox[{"Join", "[", 
                RowBox[{"oEquations", ",", "oConstraints"}], "]"}], ",", 
               "oOutput", ",", "Reals", ",", " ", "1"}], "]"}], ",", "60", 
             ",", "$Failed"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Which", "[", 
           RowBox[{
            RowBox[{"FailureQ", "[", "underCheck", "]"}], ",", 
            RowBox[{
            "Print", "[", 
             "\"\<Invalid system: distribution either underspecified or \
conflicting\>\"", "]"}], "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Length", "[", "underCheck", "]"}], " ", "\[Equal]", " ",
              "1"}], ",", 
            RowBox[{
            "Print", "[", 
             "\"\<Underspecified system: needs more valid specifications\>\"",
              "]"}], "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
            "True", ",", 
            RowBox[{
            "Print", "[", 
             "\"\<Invalid system: some specifications not consistent\>\"", 
             "]"}]}], "\[IndentingNewLine]", "]"}], ";", 
          "\[IndentingNewLine]", "$Failed"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"oRules", " ", "=", " ", 
           RowBox[{"oSolve", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"oFinalRules", " ", "=", " ", 
           RowBox[{"oRules", "//.", 
            RowBox[{
             RowBox[{"{", "x_", "}"}], "\[RuleDelayed]", "x"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"oD", " ", "=", " ", 
           RowBox[{"CategoricalDistribution", "[", 
            RowBox[{"values", ",", " ", 
             RowBox[{"oParams", " ", "/.", " ", "oFinalRules"}]}], "]"}]}], 
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Information", "[", 
           RowBox[{"oD", ",", " ", "\"\<ProbabilityTable\>\""}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"RandomVariate", "[", 
           RowBox[{"oD", ",", " ", "numsamples"}], "]"}]}]}], 
        "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{
       "Print", "[", "\"\<Invalid system: solver timed out\>\"", "]"}]}], 
      "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "*)"}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.810838578830367*^9, 3.8108385831947412`*^9}, {
  3.810838619699106*^9, 3.810838686918848*^9}, {3.810842604989357*^9, 
  3.8108426763241863`*^9}, {3.810842757906061*^9, 3.810842768777169*^9}, {
  3.810842948729786*^9, 3.810842951145462*^9}, {3.810843023662766*^9, 
  3.810843039279393*^9}, {3.810843071584235*^9, 3.810843147239332*^9}, {
  3.8108431888751574`*^9, 
  3.810843247573083*^9}},ExpressionUUID->"71af5f76-0a7f-475a-9ea0-\
84c70916ed19"]
},
WindowSize->{808, 706},
WindowMargins->{{Automatic, 87}, {Automatic, 37}},
Visible->False,
FrontEndVersion->"12.1 for Mac OS X x86 (64-bit) (March 18, 2020)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"caf56096-45e1-4c60-af0d-f275ce84c557"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 12542, 281, 1732, "Input",ExpressionUUID->"71af5f76-0a7f-475a-9ea0-84c70916ed19"]
}
]
*)

