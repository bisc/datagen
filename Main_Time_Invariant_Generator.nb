(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     11578,        277]
NotebookOptionsPosition[     11211,        262]
NotebookOutlinePosition[     11622,        279]
CellTagsIndexPosition[     11579,        276]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Clear", "[", "invariantGenerate", "]"}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "Function", " ", "for", " ", "time", " ", "invariant", " ", "generation"}],
    " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"invariantGenerate", "[", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "classes", ",", " ", "equalityAdjust", ",", "inequalityAdjust", ",", 
      "  ", "myProbAdjustEquals", ",", "myProbAdjustUnequals", ",", " ", 
      "oParams", ",", " ", "oOutput", ",", " ", "oEquations", ",", " ", 
      "oConstraints", ",", " ", "oSolve", ",", " ", "oRules", ",", " ", 
      "oFinalRules", ",", " ", "oD", ",", " ", "underCheck"}], "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Print", "[", "\"\<Before\>\"", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"classes", " ", "=", " ", "variables"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"variables", ",", " ", "values"}], "}"}], " ", "=", " ", 
      RowBox[{"timeVarVals", "[", 
       RowBox[{"timesteps", ",", " ", "variables", ",", " ", "values"}], 
       "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "\"\<Adjust Lists\>\"", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "classes", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "variables", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "values", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"testAdjust", " ", "=", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Equal", "[", 
         RowBox[{"test1_", ",", " ", "test2_"}], "]"}], ")"}], " ", 
       "\[RuleDelayed]", " ", "test1"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"equalityAdjust", " ", "=", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Equal", "[", 
         RowBox[{"test1_", ",", " ", "test2_"}], "]"}], ")"}], " ", 
       "\[RuleDelayed]", " ", 
       RowBox[{"switchEquals", "[", 
        RowBox[{
         RowBox[{"Equal", "[", 
          RowBox[{"test1", ",", " ", "test2"}], "]"}], ",", "variables", ",", 
         " ", "values"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"inequalityAdjust", " ", "=", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Unequal", "[", 
         RowBox[{"test1_", ",", " ", "test2_"}], "]"}], ")"}], " ", 
       "\[RuleDelayed]", " ", 
       RowBox[{"switchUnequals", "[", 
        RowBox[{
         RowBox[{"Unequal", "[", 
          RowBox[{"test1", ",", " ", "test2"}], "]"}], ",", "variables", ",", 
         " ", "values"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"myProbAdjustEquals", "=", " ", 
      RowBox[{
       RowBox[{"myProb", "[", "test3_", "]"}], " ", "\[RuleDelayed]", " ", 
       RowBox[{"myProb", "[", " ", 
        RowBox[{"test3", " ", "//.", " ", "equalityAdjust"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"myProbAdjustUnequals", "=", " ", 
      RowBox[{
       RowBox[{"myProb", "[", "test3_", "]"}], " ", "\[RuleDelayed]", " ", 
       RowBox[{"myProb", "[", " ", 
        RowBox[{"test3", " ", "//.", " ", "inequalityAdjust"}], "]"}]}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "\"\<Added Stationary Assumption\>\"", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"AppendTo", "[", 
      RowBox[{"specs", ",", 
       RowBox[{"stationary", "[", 
        RowBox[{"classes", ",", " ", "variables", ",", " ", "values"}], 
        "]"}]}], "]"}], ";", " ", "\[IndentingNewLine]", 
     RowBox[{"specs", " ", "=", " ", 
      RowBox[{"Flatten", "[", "specs", "]"}]}], ";", " ", 
     "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "specs", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"specs", "  ", "=", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"specs", " ", "//.", " ", "myProbAdjustEquals"}], "  ", "//.",
              "definizeRule"}], " ", "//.", " ", "eventsToDNFExtRule"}], " ", 
           "//.", " ", "myProbAdjustUnequals"}], " ", "//.", "definizeRule"}],
          " ", "//.", " ", "eventsToDNFExtRule"}], "  ", "//.", " ", 
        "myProbAdjustEquals"}], " ", "//.", " ", "myProbAdjustUnequals"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "\"\<After\>\"", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Print", "[", "specs", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Parameterizing", " ", "the", " ", "specifications", " ", "with", " ", 
       "generated", " ", "o", " ", "parameters"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"oParams", " ", "=", " ", 
      RowBox[{"oGen", "[", " ", 
       RowBox[{"variables", ",", " ", "values"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"oOutput", " ", "=", " ", 
      RowBox[{"oOutcomes", "[", "oParams", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"oEquations", "=", " ", 
      RowBox[{
       RowBox[{"specs", " ", "/.", " ", "unconditionedProbability"}], " ", "/.",
        " ", "conditionedProbability"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", "oEquations", "]"}], ";"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"AppendTo", "[", 
      RowBox[{"oEquations", ",", " ", 
       RowBox[{"givenEquation", "[", "oParams", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Solving", " ", "the", " ", "probability", " ", "system", " ", "based", 
       " ", "on", " ", "the", " ", "specifications", " ", "and", " ", 
       "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"oConstraints", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"#", "\[Element]", 
         RowBox[{"Interval", "[", 
          RowBox[{"{", 
           RowBox[{"0", ",", "1"}], "}"}], "]"}]}], "&"}], "/@", 
       "oOutput"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"oSolve", " ", "=", " ", 
      RowBox[{"TimeConstrained", "[", 
       RowBox[{
        RowBox[{"Solve", "[", 
         RowBox[{
          RowBox[{"Join", "[", 
           RowBox[{"oEquations", ",", "oConstraints"}], "]"}], ",", "oOutput",
           ",", "Reals"}], "]"}], ",", "60", ",", "$Failed"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"FailureQ", "[", "oSolve", "]"}], ",", 
       RowBox[{
       "Print", "[", "\"\<Invalid system: solver timed out\>\"", "]"}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Generating", " ", "data", " ", "by", " ", "placing", " ", "the", " ", 
       "solution", " ", "into", " ", "a", " ", "categorical", " ", 
       "distribution"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", 
        RowBox[{"FailureQ", "[", "oSolve", "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "oSolve", "]"}], " ", "\[NotEqual]", " ", 
           "1"}], " ", "||", " ", 
          RowBox[{
           RowBox[{"Length", "[", 
            RowBox[{"oSolve", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "]"}], " ", "\[NotEqual]", " ", 
           RowBox[{"Length", "[", "oOutput", "]"}]}]}], ",", " ", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"underCheck", " ", "=", " ", 
           RowBox[{"TimeConstrained", "[", 
            RowBox[{
             RowBox[{"FindInstance", "[", 
              RowBox[{
               RowBox[{"Join", "[", 
                RowBox[{"oEquations", ",", "oConstraints"}], "]"}], ",", 
               "oOutput", ",", "Reals", ",", " ", "1"}], "]"}], ",", "60", 
             ",", "$Failed"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Which", "[", 
           RowBox[{
            RowBox[{"FailureQ", "[", "underCheck", "]"}], ",", 
            RowBox[{
            "Print", "[", 
             "\"\<Invalid system: distribution either underspecified or \
conflicting\>\"", "]"}], "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Length", "[", "underCheck", "]"}], " ", "\[Equal]", " ",
              "1"}], ",", 
            RowBox[{
            "Print", "[", 
             "\"\<Underspecified system: needs more valid specifications\>\"",
              "]"}], "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
            "True", ",", 
            RowBox[{
            "Print", "[", 
             "\"\<Invalid system: some specifications not consistent\>\"", 
             "]"}]}], "\[IndentingNewLine]", "]"}], ";", 
          "\[IndentingNewLine]", "$Failed"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"oRules", " ", "=", " ", 
           RowBox[{"oSolve", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"oFinalRules", " ", "=", " ", 
           RowBox[{"oRules", "//.", 
            RowBox[{
             RowBox[{"{", "x_", "}"}], "\[RuleDelayed]", "x"}]}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "oSolve", "]"}], ";"}]}], 
        "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
       "Print", "[", "\"\<Invalid system: solver timed out\>\"", "]"}]}], 
      "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJwdxUsow3EAB/B5tJRH80iIhLDyKDFqOPwlbIxaa2liaBtqWWopW6HsICHt
YMxsCply2lJLMlwU5lEswiKvYWVt4aDJ//s7fPpkdauE8nAGg5FJwx16CXNe
5qOElS/kJOlgNC7ruUvEZ1ZLyEi/LZ1gLtCr/7ZZWO9JScC9EgMbL609kbs4
XyX40O8txXG2QAU2WXsozA8z1WGbOCDAbnPMxRa9q6iBPPa77MWa2Yw3rM+R
bhzKfVRxvJs8Waq8wdP1LbdY91WZfUKvGXCRlYbRfJw2YmbjwmAfF+9kxVdj
a8BG4eGHSB62cDnNeDckINcqBUJ865gne951bfhMHdWO968eO3F6h1OBxVPe
IVwwztHiD/fz2AN9k8qswylvyQZcE/okf9sb17E9T0xecVhO/QofFSsKXmDR
9Z5J1uujyvnti9i4erWJc50xO9gfeXSMtdX957j1h3eJq4IR93jpIOoVz1pS
vXhmjiOT07MksSr8D9SeCVo=
  
  "],ExpressionUUID->"71af5f76-0a7f-475a-9ea0-84c70916ed19"]
},
WindowSize->{808, 706},
WindowMargins->{{Automatic, 296}, {44, Automatic}},
Visible->False,
FrontEndVersion->"12.1 for Mac OS X x86 (64-bit) (March 18, 2020)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"1f2bddd3-45fd-4d1e-b6ad-5bf513510436"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 10649, 240, 1648, "Input",ExpressionUUID->"71af5f76-0a7f-475a-9ea0-84c70916ed19"]
}
]
*)

